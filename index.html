<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tecnolog√≠a & Hogar - Forwarder Venture</title>
    
    <link rel="icon" type="image/jpg" href="logo.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { background-color: #F8FAFC; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .text-fv-blue { color: #002e5f; }
        .bg-fv-blue { background-color: #002e5f; }
        .text-fv-orange { color: #e85d04; }
        .bg-fv-orange { background-color: #e85d04; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .banner-hero {
            background: linear-gradient(90deg, rgba(0,46,95,0.95) 0%, rgba(0,46,95,0.8) 50%, rgba(0,46,95,0.4) 100%), 
                        url('https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2070&auto=format&fit=crop');
            background-size: cover; background-position: center;
        }

        .variant-btn { border: 2px solid #e2e8f0; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; transition: all 0.2s; cursor: pointer; text-transform: uppercase; color: #4b5563; }
        .variant-btn.active { border-color: #002e5f; background-color: #002e5f; color: white; }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        /* Loader del Infinite Scroll */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #002e5f; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-900">

    <div class="max-w-[1400px] mx-auto bg-white min-h-screen flex flex-col shadow-2xl w-full relative">
        
        <header class="bg-white/95 backdrop-blur-md px-6 py-4 sticky top-0 z-50 flex justify-between items-center border-b border-gray-100 shadow-sm h-[80px]">
            <img src="logo.jpg" alt="Forwarder Venture" class="w-[120px] object-contain">
            <button onclick="toggleCart()" class="relative p-2 hover:bg-gray-100 rounded-full transition">
                <i class="fa-solid fa-cart-shopping text-2xl text-fv-blue"></i>
                <span id="cart-count" class="absolute top-0 right-0 bg-orange-600 text-white text-[10px] font-bold h-5 w-5 flex items-center justify-center rounded-full border-2 border-white">0</span>
            </button>
        </header>

        <section class="banner-hero p-8 md:p-20 flex items-center min-h-[300px] relative overflow-hidden">
            <div class="relative z-10 max-w-3xl text-white">
                <span class="bg-orange-600 text-white px-3 py-1 font-black text-xs uppercase tracking-widest mb-4 inline-block rounded-sm">Cat√°logo Oficial</span>
                <h1 class="text-5xl md:text-7xl font-black leading-none mb-4 uppercase drop-shadow-md">Tecnolog√≠a <br>& Hogar</h1>
                <p class="text-gray-100 text-sm md:text-lg font-medium max-w-xl drop-shadow">Soluciones inteligentes para tu d√≠a a d√≠a con el respaldo de Forwarder Venture.</p>
            </div>
        </section>

        <div class="p-6 border-b border-gray-100 sticky top-[80px] bg-white z-40 shadow-sm">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <nav id="category-nav" class="flex gap-2 overflow-x-auto w-full md:w-auto hide-scrollbar pb-1"></nav>
                
                <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto items-center">
                    <div class="relative w-full sm:w-48">
                        <select id="sort-select" onchange="applyFilters()" class="w-full pl-3 pr-10 py-3 bg-gray-50 border border-gray-300 rounded-xl text-xs font-bold text-gray-700 outline-none appearance-none cursor-pointer uppercase focus:ring-2 focus:ring-fv-blue">
                            <option value="recent">M√°s Recientes</option>
                            <option value="asc">Precio: Bajo a Alto</option>
                            <option value="desc">Precio: Alto a Bajo</option>
                            <option value="az">Nombre: A - Z</option>
                            <option value="za">Nombre: Z - A</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-[10px]"></i>
                    </div>

                    <div class="relative w-full md:w-72">
                        <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="search-input" oninput="debounceSearch()" placeholder="Buscar producto..." class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl text-xs outline-none focus:ring-2 focus:ring-fv-blue">
                    </div>
                </div>
            </div>
        </div>

        <main class="p-6 md:p-10 flex-grow bg-gray-50/50 pb-20">
            <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                </div>
            
            <div id="scroll-loader" class="hidden w-full pt-10">
                <div class="loader"></div>
                <p class="text-center text-gray-400 text-xs font-bold uppercase tracking-widest mt-2">Cargando m√°s productos...</p>
            </div>
        </main>

        <footer class="bg-gray-900 text-white py-14 px-6 border-t-4 border-orange-600 mt-auto text-center">
            <h2 class="text-2xl font-black mb-2 tracking-tighter uppercase">FORWARDER VENTURE</h2>
            <div class="flex justify-center gap-6 my-8">
                <a href="https://wa.me/573183035997" target="_blank" class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center hover:scale-110 transition shadow-lg shadow-green-900/20">
                    <i class="fa-brands fa-whatsapp text-2xl"></i>
                </a>
            </div>
            <p class="text-orange-500 font-bold text-xs uppercase tracking-widest mb-4 italic">* TODOS LOS PRECIOS SON ANTES DE IVA</p>
            <p class="text-gray-500 text-[10px] uppercase tracking-widest">¬© 2026 Forwarder Venture. Todos los derechos reservados.</p>
        </footer>
    </div>

    <div id="product-modal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white w-full max-w-xl rounded-3xl overflow-hidden relative shadow-2xl transform scale-95 transition-all flex flex-col max-h-[95vh]" id="product-modal-content">
            <button onclick="closeModal()" class="absolute top-4 right-4 w-10 h-10 bg-black/5 rounded-full flex items-center justify-center transition hover:bg-black/10 text-gray-800 z-20"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <div class="bg-gray-100 border-b border-gray-100 p-6 flex flex-col items-center shrink-0">
                <div class="h-48 md:h-64 flex items-center justify-center w-full relative">
                    <img id="modal-img" src="" class="max-h-full max-w-full object-contain drop-shadow-md">
                </div>
                <div id="modal-gallery" class="flex gap-2 mt-4 overflow-x-auto w-full justify-center hide-scrollbar p-2"></div>
            </div>

            <div class="p-6 md:p-8 overflow-y-auto flex-grow bg-white">
                <span id="modal-type" class="text-orange-600 font-black text-[10px] uppercase tracking-widest"></span>
                <h2 id="modal-title" class="text-xl md:text-2xl font-black text-fv-blue mt-1 mb-4 leading-tight uppercase"></h2>
                
                <div id="variant-section" class="mb-4 hidden">
                    <label class="text-[10px] font-black text-gray-400 uppercase mb-2 block">Opciones Principales:</label>
                    <div id="variant-container" class="flex flex-wrap gap-2"></div>
                </div>

                <div id="extra-section" class="mb-6 hidden">
                    <label class="text-[10px] font-black text-gray-400 uppercase mb-2 block">Detalles/Colores:</label>
                    <div id="extra-container" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="flex items-center justify-between mb-8 bg-gray-50 p-5 rounded-2xl border border-gray-100">
                    <div>
                        <span class="text-gray-400 text-[10px] font-black uppercase block leading-none mb-1 tracking-tight">Precio Unit. (S/IVA)</span>
                        <span id="modal-price" class="text-3xl font-black text-fv-blue"></span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-auto shrink-0">
                    <button onclick="shareSingleProduct()" class="bg-[#F0FDF4] text-[#16A34A] rounded-2xl py-4 font-black flex items-center justify-center gap-2 hover:bg-green-100 transition shadow-sm uppercase"><i class="fa-brands fa-whatsapp text-xl"></i> COMPARTIR</button>
                    <button onclick="addToCartFromModal()" class="bg-[#0F172A] text-white rounded-2xl py-4 font-black flex items-center justify-center gap-2 hover:opacity-90 transition shadow-sm uppercase"><i class="fa-solid fa-plus text-xl"></i> A√ëADIR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="hidden fixed inset-0 bg-black/60 z-[200] flex justify-end">
        <div class="bg-white w-full max-w-md h-full flex flex-col shadow-2xl animate-slide-up md:animate-none">
            <div class="p-6 border-b flex justify-between items-center bg-white">
                <h2 class="text-2xl font-black text-fv-blue uppercase tracking-tighter">TU PEDIDO</h2>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="cart-items" class="flex-grow overflow-y-auto p-6 space-y-4 bg-gray-50"></div>
            <div class="p-6 border-t bg-white">
                <div class="flex justify-between items-center mb-6">
                    <span class="font-black text-gray-400 text-xs uppercase">Total estimado (S/IVA):</span>
                    <span id="cart-total" class="text-3xl font-black text-fv-blue">$0</span>
                </div>
                <button onclick="sendOrderWhatsApp()" class="w-full bg-[#25D366] text-white py-4 rounded-2xl font-black text-lg flex items-center justify-center gap-3 shadow-lg hover:bg-[#128C7E] transition">
                    <i class="fa-brands fa-whatsapp text-2xl"></i> ENVIAR PEDIDO
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-fv-blue text-white px-6 py-3 rounded-full shadow-2xl z-[4000] transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none font-bold flex items-center gap-2">
        <i class="fa-solid fa-check-circle text-orange-400"></i> Agregado al pedido
    </div>

    <script>
        const WHATSAPP_NUMBER = '3183035997'; // Tel√©fono Tecnolog√≠a y Hogar
        const SHEET_ID = '17a0Pxq1EOLRf86yiuM014ZluVqL2Qj1Mt8cKRDenjHc';
        const GID = '0'; // Pesta√±a Tecnolog√≠a
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

        let allGroups = [];
        let filteredGroups = [];
        let cart = [];
        let currentCategory = 'Ver Todo';
        
        let selectedGroup = null;
        let selectedVariant = null;
        let currentVariable = null; 
        let currentExtra = null; 
        
        // Paginaci√≥n 
        let currentStartIndex = 0;
        const ITEMS_PER_PAGE = 50;
        let searchTimeout = null; 

        function formatMoney(amount) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        }

        // LIMPIADOR AVANZADO PARA TEXTOS Y VARIABLES (Evita duplicados falsos)
        function superClean(text) {
            if (!text) return '';
            return text.toString()
                .replace(/[\u200B-\u200D\uFEFF]/g, '') // Elimina espacios invisibles 
                .replace(/\s+/g, ' ') // Elimina saltos de l√≠nea y espacios dobles
                .trim()
                .toUpperCase();
        }

        // DESTRUCTOR DE TILDES PARA EL BUSCADOR
        function removeAccentsAndLower(text) {
            if (!text) return '';
            return text.toString()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .toLowerCase();
        }

        function loadProducts() {
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    const tempGroups = {};
                    
                    results.data.forEach((row, index) => {
                        const sku = row['SKU']?.toString().trim();
                        
                        // EVITAR EL "PRODUCTO GIGANTE": Si no hay Parent SKU ni SKU, le asignamos un ID √∫nico por fila
                        let pSku = row['PARENT SKU']?.toString().trim();
                        if(!pSku) pSku = sku || `FILA-SIN-SKU-${index}`;
                        
                        // Si la fila est√° completamente vac√≠a de nombre y sku, saltarla
                        if (!row['NOMBRE'] && !sku) return;

                        let pStr = row['PRECIO DE VENTA']?.toString() || '0';
                        pStr = pStr.replace(/[,.]\d{1,2}$/, ''); 
                        const precioVenta = parseInt(pStr.replace(/\D/g, '')) || 0;

                        const rawImgs = row['IMAGEN']?.split('|').map(i => i.trim()).filter(i => i !== "") || [];
                        const imgs = rawImgs.length > 0 ? rawImgs : ['https://via.placeholder.com/400'];

                        if (!tempGroups[pSku]) {
                            tempGroups[pSku] = {
                                id: pSku,
                                nombre: row['NOMBRE']?.trim() || 'Producto sin nombre',
                                tipo: row['TIPO']?.trim() || 'Varios',
                                index: index,
                                skuMap: {}
                            };
                        }

                        const safeVariable = superClean(row['VARIABLE']);
                        const safeExtra = superClean(row['EXTRA']);

                        // Garant√≠a de Margen: Guardar si es nuevo, o sobreescribir si el precio de venta es MAYOR
                        if (!tempGroups[pSku].skuMap[sku] || precioVenta > tempGroups[pSku].skuMap[sku].precio) {
                            tempGroups[pSku].skuMap[sku] = {
                                sku: sku,
                                variable: safeVariable,
                                extra: safeExtra,
                                imgs: imgs,
                                precio: precioVenta
                            };
                        }
                    });

                    allGroups = Object.values(tempGroups).map(group => ({
                        ...group,
                        variaciones: Object.values(group.skuMap)
                    }));

                    updateCategoryNav();
                    applyFilters();
                    checkUrlForProduct();

                    // Activar el sensor de scroll infinito
                    window.addEventListener('scroll', handleScroll);
                }
            });
        }

        function updateCategoryNav() {
            const types = ['Ver Todo', ...new Set(allGroups.map(p => p.tipo))].sort();
            document.getElementById('category-nav').innerHTML = types.map(t => {
                const isActive = t === currentCategory;
                return `<button onclick="filterType('${t}')" class="px-5 py-2 rounded-xl text-xs font-black whitespace-nowrap border transition-all ${isActive ? 'bg-fv-blue text-white shadow-md' : 'bg-white text-gray-500 hover:bg-gray-100'}">${t}</button>`;
            }).join('');
        }

        function filterType(t) { currentCategory = t; updateCategoryNav(); applyFilters(); }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        }

        function applyFilters() {
            const rawSearch = document.getElementById('search-input').value;
            const searchTerms = removeAccentsAndLower(rawSearch).split(' ').filter(t => t.length > 0);
            const sortMode = document.getElementById('sort-select').value;

            filteredGroups = allGroups.filter(p => {
                const matchType = currentCategory === 'Ver Todo' || p.tipo === currentCategory;
                
                // Buscar coincidencia ignorando tildes y may√∫sculas
                const searchText = removeAccentsAndLower(p.nombre + " " + p.tipo + " " + p.variaciones.map(v => v.variable + " " + v.extra).join(" "));
                const matchSearch = searchTerms.every(term => searchText.includes(term));
                
                return matchType && matchSearch;
            });

            // Ordenamiento
            if (sortMode === 'asc') filteredGroups.sort((a, b) => a.variaciones[0].precio - b.variaciones[0].precio);
            else if (sortMode === 'desc') filteredGroups.sort((a, b) => b.variaciones[0].precio - a.variaciones[0].precio);
            else if (sortMode === 'az') filteredGroups.sort((a, b) => a.nombre.localeCompare(b.nombre));
            else if (sortMode === 'za') filteredGroups.sort((a, b) => b.nombre.localeCompare(a.nombre));
            else if (sortMode === 'recent') filteredGroups.sort((a, b) => b.index - a.index);

            // Reiniciar scroll infinito
            currentStartIndex = 0;
            document.getElementById('product-grid').innerHTML = ''; 
            loadMoreProducts();
        }

        function loadMoreProducts() {
            const grid = document.getElementById('product-grid');
            const loader = document.getElementById('scroll-loader');
            
            if (filteredGroups.length === 0 && currentStartIndex === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-20 text-gray-400 font-bold">No se encontraron productos.</div>';
                loader.classList.add('hidden');
                return;
            }

            const end = currentStartIndex + ITEMS_PER_PAGE;
            const sliceToRender = filteredGroups.slice(currentStartIndex, end);
            
            if (sliceToRender.length > 0) {
                // IM√ÅGENES DEL MISMO TAMA√ëO: object-cover + aspect-square fuerza cuadrados perfectos
                const html = sliceToRender.map(p => {
                    const main = p.variaciones[0];
                    return `
                    <div class="bg-white rounded-2xl overflow-hidden shadow-[0_4px_20px_rgba(0,0,0,0.04)] border border-gray-100 flex flex-col cursor-pointer relative group transition-transform hover:-translate-y-1" onclick="openModal('${p.id}')">
                        <div class="w-full aspect-square relative bg-white overflow-hidden">
                            <img src="${main.imgs[0]}" loading="lazy" class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                            <div class="absolute top-3 left-3 bg-white/90 backdrop-blur px-2 py-1 rounded-md text-[9px] font-black uppercase text-fv-orange shadow-sm border border-gray-100">${p.tipo}</div>
                        </div>
                        <div class="p-4 flex flex-col flex-grow bg-white z-10 border-t border-gray-50">
                            <h3 class="font-black text-[12px] text-fv-blue leading-tight mb-2 h-8 line-clamp-2 uppercase">${p.nombre}</h3>
                            <div class="mt-auto flex justify-between items-center pt-2">
                                <p class="text-[15px] font-black text-fv-blue">${formatMoney(main.precio)}</p>
                                <div class="flex gap-2">
                                    <button onclick="quickShare(event, '${p.id}')" class="w-9 h-9 bg-[#F0FDF4] text-[#16A34A] rounded-xl flex items-center justify-center hover:bg-green-100 transition shadow-sm">
                                        <i class="fa-brands fa-whatsapp text-lg"></i>
                                    </button>
                                    <button onclick="quickAdd(event, '${p.id}')" class="w-9 h-9 bg-[#0F172A] text-white rounded-xl flex items-center justify-center hover:bg-fv-blue transition shadow-sm">
                                        <i class="fa-solid fa-plus text-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                
                grid.insertAdjacentHTML('beforeend', html);
                currentStartIndex = end;
            }

            if (currentStartIndex >= filteredGroups.length) {
                loader.classList.add('hidden');
            } else {
                loader.classList.remove('hidden');
            }
        }

        function handleScroll() {
            // Si el usuario est√° a 800px del fondo de la p√°gina, carga los siguientes 50
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 800) {
                if (currentStartIndex < filteredGroups.length) {
                    loadMoreProducts();
                }
            }
        }

        // --- L√ìGICA DE APERTURA Y FILTROS ANIDADOS ---
        function openModal(groupId) {
            selectedGroup = allGroups.find(p => p.id === groupId);
            if(!selectedGroup) return;
            
            currentVariable = selectedGroup.variaciones[0].variable;
            currentExtra = selectedGroup.variaciones[0].extra;
            
            updateVariantSelectionUI();

            window.history.pushState({}, '', `?p=${groupId}`);
            const modal = document.getElementById('product-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.replace('opacity-0', 'opacity-100');
                document.getElementById('product-modal-content').classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function selectVariable(v) {
            currentVariable = v;
            const validExtras = selectedGroup.variaciones.filter(varObj => varObj.variable === currentVariable).map(varObj => varObj.extra);
            if (!validExtras.includes(currentExtra)) currentExtra = validExtras[0] || '';
            updateVariantSelectionUI();
        }

        function selectExtra(e) {
            currentExtra = e;
            updateVariantSelectionUI();
        }

        function updateVariantSelectionUI() {
            let variant = selectedGroup.variaciones.find(v => v.variable === currentVariable && v.extra === currentExtra);
            if (!variant) variant = selectedGroup.variaciones.find(v => v.variable === currentVariable);
            selectedVariant = variant || selectedGroup.variaciones[0];

            document.getElementById('modal-title').innerText = selectedGroup.nombre;
            document.getElementById('modal-type').innerText = selectedGroup.tipo;
            document.getElementById('modal-img').src = selectedVariant.imgs[0];
            document.getElementById('modal-price').innerText = formatMoney(selectedVariant.precio);

            const gallery = document.getElementById('modal-gallery');
            if(selectedVariant.imgs.length > 1) {
                gallery.classList.remove('hidden');
                gallery.innerHTML = selectedVariant.imgs.map((img, i) => `
                    <div class="w-16 h-16 flex-shrink-0 border-2 ${i === 0 ? 'border-fv-orange' : 'border-transparent'} rounded-lg overflow-hidden cursor-pointer bg-white" onclick="changeModalImg('${img}', this)">
                        <img src="${img}" class="w-full h-full object-contain">
                    </div>`).join('');
            } else gallery.classList.add('hidden');

            const uniqueVars = [...new Set(selectedGroup.variaciones.map(v => v.variable).filter(v => v !== ''))];
            const vSection = document.getElementById('variant-section');
            if (uniqueVars.length > 0) {
                vSection.classList.remove('hidden');
                document.getElementById('variant-container').innerHTML = uniqueVars.map(v => `
                    <button onclick="selectVariable('${v}')" class="variant-btn ${v === currentVariable ? 'active' : ''}">${v}</button>`).join('');
            } else vSection.classList.add('hidden');

            const availableExtras = [...new Set(selectedGroup.variaciones.filter(v => v.variable === currentVariable).map(v => v.extra).filter(e => e !== ''))];
            const eSection = document.getElementById('extra-section');
            if (availableExtras.length > 0) {
                eSection.classList.remove('hidden');
                document.getElementById('extra-container').innerHTML = availableExtras.map(e => `
                    <button onclick="selectExtra('${e}')" class="variant-btn ${e === currentExtra ? 'active' : ''}">${e}</button>`).join('');
            } else eSection.classList.add('hidden');
        }

        function changeModalImg(url, el) {
            document.getElementById('modal-img').src = url;
            document.querySelectorAll('#modal-gallery > div').forEach(d => d.classList.replace('border-fv-orange', 'border-transparent'));
            el.classList.replace('border-transparent', 'border-fv-orange');
        }

        function closeModal() {
            const modal = document.getElementById('product-modal');
            modal.classList.replace('opacity-100', 'opacity-0');
            document.getElementById('product-modal-content').classList.replace('scale-100', 'scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 200);
            window.history.pushState({}, '', window.location.pathname);
        }

        function quickAdd(event, groupId) {
            event.stopPropagation();
            const g = allGroups.find(p => p.id === groupId);
            const v = g.variaciones[0];
            if(!cart.find(c => c.sku === v.sku)) cart.push({ ...v, nombre: g.nombre });
            updateCartUI();
            showToast();
        }

        function addToCartFromModal() {
            if(!cart.find(c => c.sku === selectedVariant.sku)) cart.push({ ...selectedVariant, nombre: selectedGroup.nombre });
            updateCartUI(); closeModal(); showToast();
        }

        function quickShare(event, groupId) {
            event.stopPropagation(); 
            const g = allGroups.find(p => p.id === groupId);
            const url = `${window.location.origin}${window.location.pathname}?p=${groupId}`;
            const text = `üõí *FORWARDER VENTURE*\n\nTecnolog√≠a y Hogar:\n*${g.nombre}*\n\nInfo: ${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareSingleProduct() { 
            const url = `${window.location.origin}${window.location.pathname}?p=${selectedGroup.id}`;
            const text = `üõí *FORWARDER VENTURE*\n\nTecnolog√≠a y Hogar:\n*${selectedGroup.nombre}*\n\nInfo: ${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function checkUrlForProduct() {
            const params = new URLSearchParams(window.location.search);
            const pId = params.get('p');
            if(pId) setTimeout(() => openModal(pId), 500);
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.length;
            const container = document.getElementById('cart-items');
            let total = 0;
            container.innerHTML = cart.map((item, i) => {
                total += item.precio;
                let varLabels = [];
                if(item.variable) varLabels.push(item.variable);
                if(item.extra) varLabels.push(item.extra);
                const tagStr = varLabels.length > 0 ? `(${varLabels.join(' - ')})` : '';

                return `
                <div class="flex gap-4 bg-white p-3 rounded-2xl border border-gray-100 shadow-sm">
                    <img src="${item.imgs[0]}" class="w-16 h-16 object-cover rounded-xl bg-gray-50">
                    <div class="flex-grow">
                        <p class="font-black text-[10px] text-fv-blue uppercase line-clamp-1">${item.nombre}</p>
                        <p class="text-[9px] text-gray-400 uppercase font-bold">${tagStr}</p>
                        <p class="font-black text-sm mt-1">${formatMoney(item.precio)}</p>
                    </div>
                    <button onclick="removeFromCart(${i})" class="text-red-400 px-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>`;
            }).join('');
            document.getElementById('cart-total').innerText = formatMoney(total);
        }

        function removeFromCart(i) { cart.splice(i, 1); updateCartUI(); }
        function toggleCart() { document.getElementById('cart-modal').classList.toggle('hidden'); }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 2000);
        }

        function sendOrderWhatsApp() {
            if(cart.length === 0) return;
            let msg = `üõí *PEDIDO - FORWARDER VENTURE*%0A%0AHola, deseo cotizar los siguientes productos de Tecnolog√≠a y Hogar:%0A%0A`;
            
            cart.forEach(item => {
                let varLabels = [];
                if(item.variable) varLabels.push(item.variable);
                if(item.extra) varLabels.push(item.extra);
                const tagStr = varLabels.length > 0 ? ` [${varLabels.join(' - ')}]` : '';
                
                msg += `‚Ä¢ *${item.nombre}*${tagStr} - ${formatMoney(item.precio)}%0A`;
            });
            
            const total = cart.reduce((acc, i) => acc + i.precio, 0);
            msg += `%0A*TOTAL ESTIMADO (S/IVA): ${formatMoney(total)}*%0A%0A_Favor confirmar disponibilidad._`;
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank');
        }

        loadProducts();
    </script>
</body>
</html>
