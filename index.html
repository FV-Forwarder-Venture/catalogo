<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo Tecnolog√≠a - Forwarder Venture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { background-color: #F3F4F6; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Colores Forwarder Venture */
        .text-fv-blue { color: #002e5f; }
        .bg-fv-blue { background-color: #002e5f; }
        .text-fv-orange { color: #e85d04; }
        .bg-fv-orange { background-color: #e85d04; }
        .accent-fv { accent-color: #e85d04; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .modal-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .price-active { background-color: #e85d04; color: white !important; transform: scale(1.02); padding-left: 8px; padding-right: 8px; border-radius: 4px; font-weight: 900 !important; }
        .price-active span { color: white !important; }

        /* Estilo para las pastillas de variantes (Colores/Tama√±os) */
        .variant-btn {
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.2s;
            background: white;
            color: #4b5563;
            cursor: pointer;
        }
        .variant-btn:hover { border-color: #002e5f; background-color: #f9fafb; }
        .variant-btn.active {
            border-color: #002e5f;
            background-color: #002e5f;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen relative text-gray-900">

    <div class="max-w-[1400px] mx-auto bg-white min-h-screen shadow-2xl relative flex flex-col">

        <header class="bg-white/95 backdrop-blur-md px-5 py-3 sticky top-0 z-50 flex justify-between items-center border-b border-gray-100 shadow-sm h-[80px]">
            <div class="flex items-center">
                <img src="logo.png" alt="Forwarder Venture" class="w-[120px] object-contain">
            </div>
            <button onclick="toggleCart()" class="relative p-2 active:scale-95 transition-transform hover:bg-gray-100 rounded-full">
                <i class="fa-solid fa-cart-shopping text-2xl text-fv-blue"></i>
                <span id="cart-count" class="absolute top-0 right-0 bg-orange-600 text-white text-[10px] font-bold h-5 w-5 flex items-center justify-center rounded-full border-2 border-white">0</span>
            </button>
        </header>

        <section class="relative w-full h-[30vh] md:h-[40vh] bg-fv-blue overflow-hidden flex items-end p-6 md:p-12">
            <img src="https://pixabay.com/images/download/geralt-artificial-intelligence-4389372_1920.jpg" class="absolute inset-0 w-full h-full object-cover opacity-40" alt="Sublimaci√≥n Fondo">
            <div class="absolute inset-0 bg-gradient-to-t from-fv-blue/90 via-fv-blue/30 to-transparent"></div>
            <div class="relative z-10 w-full">
                <span class="bg-orange-600 text-white px-3 py-1 font-black text-xs md:text-sm uppercase tracking-widest mb-3 inline-block rounded-sm shadow-sm">Cat√°logo Oficial</span>
                <h2 class="text-white font-black text-3xl md:text-5xl leading-none mb-2 drop-shadow-md">SUBLIMACI√ìN<br>& DISE√ëO</h2>
                <p class="text-gray-100 text-sm md:text-base font-medium max-w-md drop-shadow">Precios especiales por volumen para tu negocio.</p>
            </div>
        </section>

        <div class="sticky top-[80px] z-40 bg-white shadow-sm border-b border-gray-200">
            <nav id="category-nav" class="flex overflow-x-auto gap-3 px-5 py-4 hide-scrollbar"></nav>
            <div class="px-5 py-3 bg-gray-50/80 backdrop-blur-sm flex flex-col md:flex-row gap-4 justify-between items-center text-sm">
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <i class="fa-solid fa-arrow-up-wide-short text-gray-400"></i>
                    <select id="sort-select" onchange="applyFilters()" class="bg-white border border-gray-300 text-gray-700 text-xs rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2 outline-none">
                        <option value="default">Relevancia</option>
                        <option value="asc">Precio: Menor a Mayor</option>
                        <option value="desc">Precio: Mayor a Menor</option>
                        <option value="alpha">Nombre: A - Z</option>
                    </select>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <span class="text-xs font-bold text-gray-500 whitespace-nowrap"><i class="fa-solid fa-filter-circle-dollar mr-1"></i>M√°x:</span>
                    <input type="range" id="price-range" min="0" max="100000" step="1000" class="w-full accent-fv h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updatePriceLabel(this.value); applyFilters()">
                    <span id="price-label" class="text-xs font-black text-fv-blue min-w-[70px] text-right bg-white px-2 py-1 rounded border border-gray-100">$100.000</span>
                </div>
            </div>
        </div>

        <main class="p-4 md:p-10 bg-gray-50 pb-20 flex-grow">
            <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-8">
                <div class="col-span-full flex flex-col items-center justify-center py-32 text-gray-400">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-fv-blue"></i>
                    <p class="text-base font-bold uppercase tracking-widest">Cargando inventario...</p>
                </div>
            </div>
        </main>

        <footer class="bg-gray-900 text-white py-12 border-t-4 border-orange-600 mt-auto">
            <div class="flex flex-col items-center justify-center text-center px-6">
                <h3 class="font-black text-2xl tracking-tighter uppercase mb-2">FORWARDER VENTURE</h3>
                <p class="text-gray-400 text-xs mb-8 tracking-widest uppercase">Sublimaci√≥n & Dise√±o Personalizado</p>
                
                <div class="flex gap-6 mb-8">
                    <a href="https://wa.me/573114957971" target="_blank" class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-xl hover:scale-110 transition shadow-lg hover:shadow-green-500/30">
                        <i class="fa-brands fa-whatsapp"></i>
                    </a>
                    <a href="https://facebook.com" target="_blank" class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white text-xl hover:scale-110 transition shadow-lg hover:shadow-blue-600/30">
                        <i class="fa-brands fa-facebook-f"></i>
                    </a>
                    <a href="#" class="w-12 h-12 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 rounded-full flex items-center justify-center text-white text-xl hover:scale-110 transition shadow-lg hover:shadow-pink-500/30 opacity-80 hover:opacity-100" title="Instagram (Pr√≥ximamente)">
                        <i class="fa-brands fa-instagram"></i>
                    </a>
                </div>
                
                <div class="w-24 h-0.5 bg-gray-800 mb-6"></div>
                
                <p class="text-orange-500 font-bold text-xs uppercase tracking-widest mb-4">
                    * Todos los precios mostrados son ANTES DE IVA
                </p>

                <p class="text-gray-500 text-xs">
                    &copy; 2026 Forwarder Venture.<br>Todos los derechos reservados.
                </p>
            </div>
        </footer>

    </div>

    <div id="product-modal" class="hidden fixed inset-0 bg-black/80 z-[2000] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white w-full max-w-4xl rounded-2xl overflow-hidden shadow-2xl relative transform transition-all scale-95 flex flex-col md:flex-row max-h-[90vh] md:h-auto" id="product-modal-content">
            <button onclick="closeProductModal()" class="absolute top-4 right-4 w-10 h-10 bg-black/10 hover:bg-black/20 rounded-full flex items-center justify-center z-10 transition">
                <i class="fa-solid fa-xmark text-xl text-gray-800"></i>
            </button>
            
            <div class="w-full md:w-1/2 bg-gray-50 p-6 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-gray-200">
                <div class="w-full aspect-square flex items-center justify-center mb-4 bg-white rounded-xl shadow-sm border border-gray-100 p-2">
                    <img id="modal-img" src="" class="w-full h-full object-contain max-h-[350px]">
                </div>
                <div id="modal-gallery" class="flex gap-2 overflow-x-auto w-full px-1 py-2 hide-scrollbar justify-center"></div>
            </div>
            
            <div class="w-full md:w-1/2 p-6 md:p-8 flex flex-col justify-between overflow-y-auto">
                <div>
                    <span id="modal-category" class="text-xs font-black text-orange-600 uppercase tracking-widest">CATEGOR√çA</span>
                    <h2 id="modal-title" class="text-2xl md:text-3xl font-black text-gray-900 leading-tight mt-1 mb-2">Nombre</h2>
                    <p class="text-gray-500 text-xs mb-4 font-mono bg-gray-50 inline-block px-2 py-1 rounded">SKU: <span id="modal-sku" class="font-bold text-gray-800"></span></p>
                    
                    <div id="variant-section" class="mb-6 hidden">
                        <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Opciones:</label>
                        <div id="variant-container" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div class="bg-white rounded-xl p-4 mb-6 border border-gray-200 shadow-sm">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-tags text-orange-500"></i> Descuentos por Volumen
                        </p>
                        <div class="grid grid-cols-2 gap-y-2 text-sm">
                            <div id="row-1" class="flex justify-between border-b border-gray-100 pb-1 transition-all">
                                <span class="text-gray-600">1+ und</span>
                                <span id="price-1" class="font-bold text-gray-900"></span>
                            </div>
                            <div id="row-12" class="flex justify-between border-b border-gray-100 pb-1 transition-all">
                                <span class="text-gray-600">12+ und</span>
                                <span id="price-12" class="font-bold text-fv-blue"></span>
                            </div>
                            <div id="row-50" class="flex justify-between border-b border-gray-100 pb-1 transition-all">
                                <span class="text-gray-600">50+ und</span>
                                <span id="price-50" class="font-bold text-fv-blue"></span>
                            </div>
                            <div id="row-100" class="flex justify-between border-b border-gray-100 pb-1 transition-all">
                                <span class="text-gray-600">100+ und</span>
                                <span id="price-100" class="font-bold text-fv-blue"></span>
                            </div>
                            <div id="row-200" class="flex justify-between transition-all">
                                <span class="text-gray-600">200+ und</span>
                                <span id="price-200" class="font-bold text-fv-blue"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Ingresa la Cantidad:</label>
                        <div class="flex items-center border-2 border-fv-blue rounded-xl h-14 overflow-hidden w-full max-w-[200px] shadow-sm">
                            <button onclick="updateModalInput(-1)" class="w-14 h-full bg-gray-50 hover:bg-gray-200 text-gray-600 font-bold text-2xl active:scale-95 transition">-</button>
                            <input type="number" id="modal-qty-input" value="1" min="1" class="w-full h-full text-center font-black text-2xl border-none focus:ring-0 text-fv-blue bg-white" oninput="highlightActivePrice()">
                            <button onclick="updateModalInput(1)" class="w-14 h-full bg-gray-50 hover:bg-gray-200 text-gray-600 font-bold text-2xl active:scale-95 transition">+</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-6 gap-2 mt-auto">
                    <button onclick="shareProduct()" class="col-span-1 bg-gray-100 text-gray-600 rounded-xl flex items-center justify-center hover:bg-gray-200 transition h-14" title="Copiar Enlace">
                        <i class="fa-solid fa-link text-xl"></i>
                    </button>
                    <button onclick="shareProductWhatsApp()" class="col-span-1 bg-green-500 text-white rounded-xl flex items-center justify-center hover:bg-green-600 transition shadow-sm h-14" title="WhatsApp">
                        <i class="fa-brands fa-whatsapp text-2xl"></i>
                    </button>
                    <button id="modal-add-btn" class="col-span-4 bg-fv-blue text-white rounded-xl font-bold text-lg hover:opacity-90 transition flex items-center justify-center gap-2 shadow-lg h-14">
                        Agregar al Pedido <i class="fa-solid fa-cart-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="hidden fixed inset-0 bg-black/60 z-[3000] flex items-end md:items-center justify-center transition-opacity backdrop-blur-sm p-0 md:p-6">
        <div class="bg-white w-full md:max-w-xl h-[85vh] md:h-[80vh] rounded-t-3xl md:rounded-3xl flex flex-col overflow-hidden shadow-2xl relative animate-slide-up">
            <div class="px-6 py-5 flex justify-between items-center border-b border-gray-100 bg-white">
                <h2 class="text-xl md:text-2xl font-black text-fv-blue">Tu Pedido</h2>
                <button onclick="toggleCart()" class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div id="cart-items" class="flex-grow p-5 md:p-8 overflow-y-auto space-y-4 bg-gray-50"></div>
            <div class="p-6 md:p-8 bg-white border-t border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-gray-500 font-semibold uppercase text-sm">Total Estimado:</span>
                    <span id="cart-total" class="text-3xl font-black text-fv-blue">$0</span>
                </div>
                <button onclick="sendToWhatsApp()" class="w-full bg-[#25D366] text-white py-4 rounded-2xl font-black text-lg flex justify-center items-center gap-3 shadow-lg hover:bg-[#128C7E] transition">
                    <i class="fa-brands fa-whatsapp text-2xl"></i> Enviar Pedido
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-fv-blue text-white px-6 py-3 rounded-full shadow-2xl z-[4000] transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-3 font-bold">
        <i class="fa-solid fa-check-circle text-orange-400 text-xl"></i> <span id="toast-msg">Mensaje</span>
    </div>

    <script>
        const WHATSAPP_NUMBER = '3114957971';
        const SHEET_ID = '17a0Pxq1EOLRf86yiuM014ZluVqL2Qj1Mt8cKRDenjHc';
        const GID = '129591070';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

        let allProducts = [];
        let cart = [];
        let currentCategory = 'Ver Todo';
        let maxPriceAvailable = 0;
        
        let selectedProduct = null;
        let selectedVariant = null;

        // Funci√≥n auxiliar para forzar el formato en miles con punto (Colombia)
        function formatMoney(amount) {
            return amount.toLocaleString('es-CO');
        }

        function loadProducts() {
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    const tempGroups = {};

                    results.data.forEach((row) => {
                        const pSku = row['PARENT SKU']?.trim();
                        const sku = row['SKU']?.trim();
                        if(!sku) return;

                        const groupID = (pSku && pSku !== "") ? pSku : sku;

                        if (!tempGroups[groupID]) {
                            tempGroups[groupID] = {
                                id: groupID,
                                slug: row['NOMBRE']?.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''),
                                nombre: row['NOMBRE'],
                                categoria: row['TIPO'] || 'Otros',
                                variaciones: []
                            };
                        }

                        const parsePrice = (v) => parseFloat(v?.toString().replace(/[^0-9]/g, '')) || 0;
                        
                        tempGroups[groupID].variaciones.push({
                            sku: sku,
                            color: row['COLOR']?.trim() || '',
                            variable: row['VARIABLE']?.trim() || '',
                            img: row['IMAGEN']?.split(',')[0].trim() || 'https://placehold.co/800x800/EEEEEE/999999?text=Sin+Imagen',
                            prices: {
                                p1: parsePrice(row['PRECIO 1']),
                                p12: parsePrice(row['PRECIO 12']) || parsePrice(row['PRECIO 1']),
                                p50: parsePrice(row['PRECIO 50']) || parsePrice(row['PRECIO 1']),
                                p100: parsePrice(row['PRECIO 100']) || parsePrice(row['PRECIO 1']),
                                p200: parsePrice(row['PRECIO 200']) || parsePrice(row['PRECIO 1'])
                            }
                        });
                    });

                    allProducts = Object.values(tempGroups);

                    if(allProducts.length > 0) {
                        maxPriceAvailable = Math.max(...allProducts.map(p => p.variaciones[0].prices.p1));
                        if(maxPriceAvailable === 0) maxPriceAvailable = 100000;
                        setupFilters(maxPriceAvailable);
                        initApp();
                    } else {
                        document.getElementById('product-grid').innerHTML = '<div class="col-span-full text-center py-20 text-gray-500"><i class="fa-solid fa-box-open text-4xl mb-3 opacity-50"></i><p class="font-bold">No se encontraron productos.</p></div>';
                    }
                },
                error: (err) => console.error("Error CSV:", err)
            });
        }

        function getDynamicPrice(prices, qty) {
            if (qty >= 200) return prices.p200;
            if (qty >= 100) return prices.p100;
            if (qty >= 50) return prices.p50;
            if (qty >= 12) return prices.p12;
            return prices.p1;
        }

        function setupFilters(maxPrice) {
            const range = document.getElementById('price-range');
            const limit = Math.max(Math.ceil(maxPrice * 1.1), 50000);
            range.max = limit;
            range.value = limit;
            updatePriceLabel(limit);
        }

        function updatePriceLabel(val) {
            document.getElementById('price-label').innerText = '$' + formatMoney(parseInt(val));
        }

        function applyFilters() {
            const sortValue = document.getElementById('sort-select').value;
            let maxPriceInput = parseInt(document.getElementById('price-range').value);
            if(isNaN(maxPriceInput)) maxPriceInput = maxPriceAvailable;

            let filtered = allProducts.filter(p => {
                const matchCat = currentCategory === 'Ver Todo' || p.categoria === currentCategory;
                const matchPrice = p.variaciones[0].prices.p1 <= maxPriceInput;
                return matchCat && matchPrice;
            });

            if (sortValue === 'asc') filtered.sort((a, b) => a.variaciones[0].prices.p1 - b.variaciones[0].prices.p1);
            else if (sortValue === 'desc') filtered.sort((a, b) => b.variaciones[0].prices.p1 - a.variaciones[0].prices.p1);
            else if (sortValue === 'alpha') filtered.sort((a, b) => a.nombre.localeCompare(b.nombre));

            renderProducts(filtered);
        }

        function initApp() {
            updateCategoryNav();
            applyFilters();
            checkUrlForProduct(); 
        }

        function updateCategoryNav() {
            const uniqueCats = [...new Set(allProducts.map(p => p.categoria).filter(c => c && c.trim() !== ''))];
            const categories = ['Ver Todo', ...uniqueCats.sort()];
            document.getElementById('category-nav').innerHTML = categories.map(cat => {
                const isActive = cat === currentCategory;
                const activeClasses = isActive ? "bg-fv-blue text-white border-fv-blue shadow-md" : "bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-gray-300";
                return `<button onclick="filterCategory('${cat}')" class="px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap border transition-all ${activeClasses}">${cat}</button>`;
            }).join('');
        }

        function filterCategory(cat) { 
            currentCategory = cat; 
            updateCategoryNav();
            applyFilters();
        }

        function renderProducts(products) {
            const grid = document.getElementById('product-grid');
            if (products.length === 0) return grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400"><i class="fa-solid fa-filter-circle-xmark text-5xl mb-3 text-gray-300"></i><p class="font-bold">No hay productos que coincidan.</p><button onclick="resetFilters()" class="mt-4 text-fv-blue underline text-sm">Restablecer filtros</button></div>`;
            
            grid.innerHTML = products.map((p) => {
                const mainVar = p.variaciones[0];
                return `
                <div class="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all border border-gray-100 flex flex-col group cursor-pointer animate-fade-in" onclick="openProductModal('${p.id}')">
                    <div class="relative aspect-square bg-white p-4">
                        <img src="${mainVar.img}" class="w-full h-full object-contain transition-transform duration-500 group-hover:scale-105" loading="lazy" alt="${p.nombre}">
                        ${mainVar.prices.p1 === 0 ? '<span class="absolute top-2 right-2 bg-gray-800 text-white text-[10px] px-2 py-1 rounded-full font-bold uppercase">Cotizar</span>' : ''}
                    </div>
                    <div class="p-4 flex-grow flex flex-col justify-between bg-gradient-to-b from-white to-gray-50/50">
                        <div>
                            <p class="text-[10px] text-orange-600 uppercase tracking-widest font-black mb-1 truncate">${p.categoria}</p>
                            <h3 class="font-bold text-sm text-gray-900 leading-tight line-clamp-2 group-hover:text-fv-blue transition-colors">${p.nombre}</h3>
                        </div>
                        <div class="mt-3 flex justify-between items-end">
                            <span class="text-fv-blue font-black text-lg">${mainVar.prices.p1 > 0 ? '$' + formatMoney(mainVar.prices.p1) : 'Cotizar'}</span>
                            <div class="w-9 h-9 bg-fv-blue text-white rounded-full flex items-center justify-center shadow-md group-hover:bg-orange-600 group-hover:shadow-lg transition-all">
                                <i class="fa-solid fa-plus text-sm"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function resetFilters() {
            currentCategory = 'Ver Todo';
            document.getElementById('sort-select').value = 'default';
            const range = document.getElementById('price-range');
            range.value = range.max;
            updatePriceLabel(range.max);
            updateCategoryNav();
            applyFilters();
        }

        function openProductModal(id) {
            selectedProduct = allProducts.find(prod => prod.id === id);
            if(!selectedProduct) return;
            selectedVariant = selectedProduct.variaciones[0];

            document.getElementById('modal-category').innerText = selectedProduct.categoria;
            document.getElementById('modal-title').innerText = selectedProduct.nombre;
            
            const variantContainer = document.getElementById('variant-container');
            const variantSection = document.getElementById('variant-section');
            
            if (selectedProduct.variaciones.length > 1) {
                variantSection.classList.remove('hidden');
                variantContainer.innerHTML = selectedProduct.variaciones.map((v, i) => {
                    const label = v.color || v.variable || `Opci√≥n ${i+1}`;
                    return `<button class="variant-btn ${i === 0 ? 'active' : ''}" onclick="selectVariant(${i}, this)">${label}</button>`;
                }).join('');
            } else {
                variantSection.classList.add('hidden');
            }

            updateModalUI();

            document.getElementById('modal-add-btn').onclick = () => { 
                const qty = parseInt(document.getElementById('modal-qty-input').value) || 1;
                addToCart(qty); 
                closeProductModal(); 
            };
            
            const modal = document.getElementById('product-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('product-modal-content').classList.remove('scale-95');
                document.getElementById('product-modal-content').classList.add('scale-100');
            }, 10);
            updateUrl(selectedProduct.slug);
        }

        function selectVariant(index, btn) {
            selectedVariant = selectedProduct.variaciones[index];
            document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateModalUI();
        }

        function updateModalUI() {
            document.getElementById('modal-img').src = selectedVariant.img;
            document.getElementById('modal-sku').innerText = selectedVariant.sku;
            
            const formatP = (price) => price > 0 ? '$' + formatMoney(price) : 'Cotizar';
            document.getElementById('price-1').innerText = formatP(selectedVariant.prices.p1);
            document.getElementById('price-12').innerText = formatP(selectedVariant.prices.p12);
            document.getElementById('price-50').innerText = formatP(selectedVariant.prices.p50);
            document.getElementById('price-100').innerText = formatP(selectedVariant.prices.p100);
            document.getElementById('price-200').innerText = formatP(selectedVariant.prices.p200);

            document.getElementById('modal-qty-input').value = 1;
            highlightActivePrice();
        }

        function updateModalInput(change) {
            const input = document.getElementById('modal-qty-input');
            let val = parseInt(input.value) || 0;
            val += change;
            if(val < 1) val = 1;
            input.value = val;
            highlightActivePrice();
        }

        function highlightActivePrice() {
            const qty = parseInt(document.getElementById('modal-qty-input').value) || 1;
            ['row-1', 'row-12', 'row-50', 'row-100', 'row-200'].forEach(id => {
                document.getElementById(id).classList.remove('price-active');
            });
            if (qty >= 200) document.getElementById('row-200').classList.add('price-active');
            else if (qty >= 100) document.getElementById('row-100').classList.add('price-active');
            else if (qty >= 50) document.getElementById('row-50').classList.add('price-active');
            else if (qty >= 12) document.getElementById('row-12').classList.add('price-active');
            else document.getElementById('row-1').classList.add('price-active');
        }

        function closeProductModal() {
            const modal = document.getElementById('product-modal');
            modal.classList.add('opacity-0');
            document.getElementById('product-modal-content').classList.remove('scale-100');
            document.getElementById('product-modal-content').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 200);
            clearUrl();
        }

        function addToCart(qty = 1) {
            const item = {
                sku: selectedVariant.sku,
                nombre: selectedProduct.nombre,
                variante: selectedVariant.color || selectedVariant.variable || '',
                img: selectedVariant.img,
                qty: qty,
                prices: selectedVariant.prices
            };

            const existing = cart.find(i => i.sku === item.sku);
            if (existing) existing.qty += qty; else cart.push(item);
            
            updateCartUI();
            showToast("Agregado al pedido");
            const count = document.getElementById('cart-count');
            count.classList.add('scale-125', 'bg-orange-500');
            setTimeout(() => count.classList.remove('scale-125', 'bg-orange-500'), 200);
        }

        function updateCartItemQty(index, newQty) {
            const qty = parseInt(newQty);
            if(qty < 1) cart[index].qty = 1;
            else cart[index].qty = qty;
            updateCartUI();
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
            const container = document.getElementById('cart-items');
            let total = 0;
            let hasQuoteItems = false;

            if(cart.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 py-10"><i class="fa-solid fa-cart-shopping text-5xl opacity-30 mb-4"></i><p class="font-bold">Tu pedido est√° vac√≠o</p><button onclick="toggleCart()" class="mt-4 text-fv-blue underline text-sm">Volver al cat√°logo</button></div>`;
            } else {
                container.innerHTML = cart.map((item, i) => {
                    const currentPrice = getDynamicPrice(item.prices, item.qty);
                    if(currentPrice > 0) total += currentPrice * item.qty; else hasQuoteItems = true;
                    
                    const priceDisplay = currentPrice > 0 ? `$${formatMoney(currentPrice)}` : '<span class="text-orange-600 font-bold text-xs uppercase">Cotizar</span>';
                    const subtotalDisplay = currentPrice > 0 ? `$${formatMoney(currentPrice * item.qty)}` : 'Cotizar';

                    return `
                        <div class="flex gap-3 items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm transition-all hover:border-orange-200">
                            <img src="${item.img}" class="w-16 h-16 object-contain bg-gray-50 rounded-lg border border-gray-50 p-1">
                            <div class="flex-grow overflow-hidden">
                                <p class="font-bold text-sm leading-tight truncate text-fv-blue">${item.nombre}</p>
                                <p class="text-xs text-gray-500 mt-1 mb-2">SKU: ${item.sku} ${item.variante ? '| ' + item.variante : ''}</p>
                                
                                <div class="flex justify-between items-end">
                                    <div class="flex items-center border border-gray-300 rounded-lg h-8 w-24 overflow-hidden">
                                        <input type="number" value="${item.qty}" min="1" class="w-full h-full text-center text-sm font-bold border-none focus:ring-0 p-0 text-gray-700" onchange="updateCartItemQty(${i}, this.value)">
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs text-gray-400">Unit: ${priceDisplay}</p>
                                        <p class="font-bold text-sm text-fv-blue">${subtotalDisplay}</p>
                                    </div>
                                </div>
                            </div>
                            <button onclick="removeFromCart(${i})" class="w-8 h-8 text-red-400 hover:bg-red-50 rounded-full transition ml-2 self-center"><i class="fa-solid fa-trash-can"></i></button>
                        </div>`;
                }).join('');
            }
            
            const totalLabel = hasQuoteItems && total > 0 ? `$${formatMoney(total)} + Cotizaci√≥n` : (total > 0 ? `$${formatMoney(total)}` : (hasQuoteItems ? 'Por Cotizar' : '$0'));
            document.getElementById('cart-total').innerText = totalLabel;
        }

        function removeFromCart(i) { cart.splice(i, 1); updateCartUI(); }
        function toggleCart() { document.getElementById('cart-modal').classList.toggle('hidden'); }

        function sendToWhatsApp() {
            if (cart.length === 0) return;
            let msg = `üé® *PEDIDO SUBLIMACI√ìN - FORWARDER VENTURE*%0A`;
            msg += `Hola, me interesan los siguientes productos:%0A%0A`;
            
            let total = 0;
            let quoteItems = [];

            cart.forEach(i => { 
                const currentPrice = getDynamicPrice(i.prices, i.qty);
                const unitPriceStr = currentPrice > 0 ? `$${formatMoney(currentPrice)}` : 'Cotizar';
                const totalStr = currentPrice > 0 ? `$${formatMoney(currentPrice * i.qty)}` : 'A Cotizar';
                
                msg += `üì¶ *${i.nombre}*%0A`;
                if(i.variante) msg += `   ‚îî Opci√≥n: ${i.variante} (SKU: ${i.sku})%0A`;
                msg += `   ‚îî Cant: ${i.qty} | Unit: ${unitPriceStr} | Total: ${totalStr}%0A`;
                
                if(currentPrice > 0) total += currentPrice * i.qty;
                else quoteItems.push(i.nombre);
            });

            msg += `%0A-----------------------------------%0A`;
            
            if(total > 0) {
                 msg += `üí∞ *TOTAL (Antes de IVA): $${formatMoney(total)}*`;
                 if(quoteItems.length > 0) msg += ` (+ Productos a cotizar)`;
                 msg += `%0A`;
            } else if (quoteItems.length > 0) {
                 msg += `üí∞ *TOTAL: Se requiere cotizaci√≥n*%0A`;
            }

            msg += `-----------------------------------%0A`;
            msg += `Quedo atento a la confirmaci√≥n.%0A`;

            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank');
        }

        function shareProductWhatsApp() {
            const url = window.location.href;
            const text = `¬°Mira este producto de Forwarder Venture! üé®\n\n*${selectedProduct.nombre}*\n${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function checkUrlForProduct() {
            const params = new URLSearchParams(window.location.search);
            const productSlug = params.get('p');
            if (productSlug && allProducts.length > 0) {
                const product = allProducts.find(p => p.slug === productSlug);
                if (product) openProductModal(product.id);
            }
        }
        
        function updateUrl(slug) { window.history.pushState({path: slug}, '', '?p=' + slug); }
        function clearUrl() { window.history.pushState({path: '/'}, '', window.location.pathname.split('?')[0]); }
        function shareProduct() { 
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast("Enlace directo copiado üîó"))
                .catch(() => showToast("Error al copiar enlace"));
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
        }

        loadProducts();
    </script>
</body>
</html>
