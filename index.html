<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cat√°logo | Forwarder Venture</title>
    <style>
        :root {
            --primary: #ff4e00; 
            --bg-color: #f5f5f5;
            --text-main: #333;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); padding-bottom: 20px; }

        /* --- CABECERA --- */
        header {
            background: white; padding: 10px 15px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .logo { height: 80px; width: auto; max-width: 70%; object-fit: contain; }
        
        .cart-icon { position: relative; cursor: pointer; font-size: 1.8rem; padding: 5px; }
        .cart-badge {
            position: absolute; top: 0px; right: -5px; background: var(--primary); color: white;
            border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; font-weight: bold;
        }

        /* --- FILTROS --- */
        .controls-wrapper { background: white; padding: 10px 15px; margin-bottom: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-bar { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 25px; font-size: 1rem; outline: none; background-color: #f9f9f9; margin-bottom: 10px; }
        .search-bar:focus { border-color: var(--primary); background-color: white; }
        
        .filters-container { display: flex; gap: 10px; }
        .filter-select { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; font-size: 0.9rem; outline: none; background-color: #f9f9f9; cursor: pointer; }

        /* --- GRILLA --- */
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 8px; max-width: 1000px; margin: 0 auto; }

        .product-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; }
        
        /* --- IM√ÅGENES CUADRADAS 1:1 Y CARRUSEL --- */
        .image-wrapper { 
            position: relative; 
            width: 100%; 
            padding-top: 100%; /* ESTO LO HACE CUADRADO */
            background-color: #fff; 
            overflow: hidden;
        }
        .product-img { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; /* Ajusta la imagen sin cortarla */
            opacity: 0; transition: opacity 0.3s; z-index: 1; 
            background: white;
        }
        .product-img.active { opacity: 1; z-index: 2; }
        
        /* Flechas del carrusel */
        .carousel-btn { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            background: rgba(255,255,255,0.9); border: none; width: 30px; height: 30px; 
            border-radius: 50%; font-size: 1.2rem; color: #333; cursor: pointer; 
            z-index: 10; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); 
        }
        .carousel-btn.prev { left: 5px; }
        .carousel-btn.next { right: 5px; }
        
        /* Ocultar los puntos */
        .dots-container { display: none !important; }

        /* --- INFO PRODUCTO --- */
        .info { padding: 8px; display: flex; flex-direction: column; flex-grow: 1; }
        .price { color: var(--primary); font-weight: 800; font-size: 1.15rem; }
        .price-desde { font-size: 0.75rem; color: #777; font-weight: normal; margin-right: 3px; }
        .name { font-size: 0.85rem; color: #333; margin: 4px 0 8px 0; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .variant-tag { font-size: 0.75rem; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 5px; align-self: flex-start;}

        .btn-add { margin-top: auto; background: #111; color: white; border: none; padding: 8px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-add:active { background: var(--primary); transform: scale(0.98); }

        /* --- CARRITO --- */
        #cart-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: flex-end; }
        .cart-content { background: white; width: 85%; max-width: 400px; height: 100%; display: flex; flex-direction: column; animation: slideIn 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .cart-header { padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
        .close-cart { cursor: pointer; font-size: 1.5rem; color: #888; }
        .cart-items { padding: 15px; flex-grow: 1; overflow-y: auto; }
        
        .cart-item { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .cart-item img { width: 60px; height: 60px; object-fit: contain; border-radius: 5px; border: 1px solid #eee; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-title { font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
        .cart-item-price { color: var(--primary); font-size: 0.9rem; font-weight: bold; }
        .cart-item-variant { font-size: 0.7rem; color: #666; background: #f0f0f0; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-bottom: 3px; }
        
        .qty-controls { display: flex; align-items: center; gap: 12px; margin-top: 5px; }
        .qty-btn { background: #f0f0f0; border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        
        .cart-footer { padding: 15px; border-top: 1px solid #ddd; background: white; }
        .cart-total { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        .btn-whatsapp { display: block; width: 100%; background: #25D366; color: white; text-align: center; padding: 14px; border-radius: 25px; font-weight: bold; font-size: 1rem; border: none; cursor: pointer; }

        #loader { text-align: center; padding: 40px; color: #888; grid-column: 1 / -1; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 25px; font-size: 0.9rem; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; }

        @media (min-width: 768px) { .grid-container { grid-template-columns: repeat(4, 1fr); } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>

    <header>
        <img src="logo.jpg" alt="Forwarder Venture" class="logo" onerror="this.style.display='none'">
        <div class="cart-icon" onclick="toggleCart()">
            üõí <span class="cart-badge" id="cart-count">0</span>
        </div>
    </header>

    <div class="controls-wrapper">
        <input type="text" id="searchInput" class="search-bar" placeholder="Buscar por nombre o SKU..." oninput="aplicarFiltros()">
        <div class="filters-container">
            <select id="filterTipo" class="filter-select" onchange="aplicarFiltros()">
                <option value="">Todos los tipos</option>
            </select>
            <select id="sortPrecio" class="filter-select" onchange="aplicarFiltros()">
                <option value="recent">M√°s recientes</option>
                <option value="asc">Precio: Menor a Mayor</option>
                <option value="desc">Precio: Mayor a Menor</option>
            </select>
        </div>
    </div>

    <div id="app" class="grid-container">
        <div id="loader">Cargando cat√°logo...</div>
    </div>

    <div id="cart-modal">
        <div class="cart-content">
            <div class="cart-header">Tu Carrito <span class="close-cart" onclick="toggleCart()">&times;</span></div>
            <div class="cart-items" id="cart-items-container"></div>
            <div class="cart-footer">
                <div class="cart-total"><span>Total:</span><span id="cart-total-price">$0</span></div>
                <button class="btn-whatsapp" onclick="enviarPedido()">Finalizar Pedido en WhatsApp</button>
            </div>
        </div>
    </div>

    <div id="toast">Agregado al carrito</div>

    <script>
        // -------------------------------------------------------------
        // üëá PEGA AQU√ç TU ENLACE CSV DE GOOGLE SHEETS üëá
        // -------------------------------------------------------------
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3XO-nqSQGQ6YdoAj7Nn5H-cyiWYb2Mw1ICSpkqYXP5JbZT7eXG4fb7S7JamNH2BbJCv8ZZrMnvcG1/pub?gid=0&single=true&output=csv'; 
        const NUMERO_WHATSAPP = '573183035997';

        let productosAgrupados = [];
        let productosFiltrados = [];
        window.diccionarioVariantes = {}; 
        let carrito = {};
        
        let itemsRenderizados = 0;
        const ITEMS_POR_PAGINA = 30; 

        async function cargarCatalogo() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    let dataRaw = results.data;
                    let mapGrupos = {};
                    let tiposUnicos = new Set();
                    
                    dataRaw.forEach((p, index) => {
                        let nombre = ''; let precioCosto = 0; let precioVenta = 0;
                        let variable = '√önica'; let tipo = 'Otros'; let sku = ''; let imagen = '';
                        let parentSku = '';
                        
                        // Normalizaci√≥n de columnas
                        for (let key in p) {
                            let k = String(key).toUpperCase().trim();
                            if (k === 'PRECIO') precioCosto = Number(String(p[key]).replace(/[^\d]/g, ""));
                            else if (k === 'PRECIO DE VENTA') precioVenta = Number(String(p[key]).replace(/[^\d]/g, ""));
                            else if (k === 'NOMBRE') nombre = String(p[key]).trim();
                            else if (k === 'VARIABLE') variable = String(p[key]).trim() || '√önica';
                            else if (k === 'TIPO') tipo = String(p[key]).trim() || 'Otros';
                            else if (k === 'IMAGEN') imagen = String(p[key]).trim();
                            else if (k === 'SKU') sku = String(p[key]).trim();
                            else if (k === 'SKU PADRE' || k === 'PARENT SKU') parentSku = String(p[key]).trim();
                        }
                        
                        let precioFinal = precioVenta > 0 ? precioVenta : precioCosto;
                        if (!nombre || precioFinal <= 0) return; 
                        
                        // Agrupar por Parent SKU, luego SKU, luego Nombre
                        let keyGrupo = parentSku || sku || nombre.toLowerCase();

                        if (!mapGrupos[keyGrupo]) {
                            mapGrupos[keyGrupo] = {
                                idGrupo: "GRP-" + Math.random().toString(36).substr(2, 9),
                                nombre: nombre,
                                tipo: tipo,
                                precioMinimo: precioFinal,
                                originalIndex: index, 
                                variantes: []
                            };
                        }

                        // Agregar variante al grupo
                        mapGrupos[keyGrupo].variantes.push({ 
                            NOMBRE: nombre, 
                            PRECIO: precioFinal, 
                            VARIABLE: variable, 
                            SKU: sku, 
                            IMAGEN: imagen 
                        });

                        // Actualizar precio m√≠nimo ("Desde...")
                        if (precioFinal < mapGrupos[keyGrupo].precioMinimo) {
                            mapGrupos[keyGrupo].precioMinimo = precioFinal;
                        }
                        if(tipo !== 'Otros') tiposUnicos.add(tipo);
                    });

                    productosAgrupados = Object.values(mapGrupos);
                    
                    if (productosAgrupados.length === 0) {
                        document.getElementById('loader').innerHTML = `<div style="color:#c62828; padding:20px;">Cat√°logo vac√≠o. Revisa las columnas del Excel.</div>`;
                        return;
                    }

                    // Llenar filtro TIPO
                    let selectTipo = document.getElementById('filterTipo');
                    Array.from(tiposUnicos).sort().forEach(t => {
                        if(t) selectTipo.innerHTML += `<option value="${t}">${t}</option>`;
                    });

                    // Ordenar por defecto: M√°s recientes
                    productosAgrupados.sort((a, b) => b.originalIndex - a.originalIndex);
                    productosFiltrados = [...productosAgrupados];
                    
                    renderizarSiguienteLote();
                }
            });
        }

        const formatoMoneda = (valor) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(valor);

        // Procesador de imagen Cloudinary (Cuadrado 1:1, Relleno blanco)
        function procesarImagen(linkCrudo) {
            if (!linkCrudo) return 'https://via.placeholder.com/500x500.png?text=Sin+Imagen';
            if (linkCrudo.includes('/upload/')) {
                // ar_1:1 = Aspect Ratio Cuadrado
                // c_pad = Rellenar (no recortar)
                // b_white = Fondo blanco para el relleno
                return linkCrudo.replace('/upload/', '/upload/f_auto,q_auto,w_500,ar_1:1,c_pad,b_white/');
            }
            return linkCrudo;
        }

        function renderizarSiguienteLote() {
            const container = document.getElementById('app');
            if (itemsRenderizados === 0) {
                container.innerHTML = ''; 
                if (productosFiltrados.length === 0) {
                    container.innerHTML = '<p style="text-align:center; grid-column:1/-1; padding:20px; color:#666;">No se encontraron productos.</p>';
                    return;
                }
            }

            const lote = productosFiltrados.slice(itemsRenderizados, itemsRenderizados + ITEMS_POR_PAGINA);

            lote.forEach((grupo) => {
                window.diccionarioVariantes[grupo.idGrupo] = grupo;
                
                // --- CONSTRUCCI√ìN DEL CARRUSEL BASADO EN VARIANTES ---
                let imgsHtml = '';
                let navHtml = '';
                let hayVarias = grupo.variantes.length > 1;

                grupo.variantes.forEach((v, i) => {
                    // Si la variante no tiene foto, usa la primera disponible del grupo
                    let imgBase = v.IMAGEN || grupo.variantes[0].IMAGEN;
                    let imgFinal = procesarImagen(imgBase);
                    let activeClass = i === 0 ? 'active' : '';
                    // Data-idx es crucial para saber qu√© variante es
                    imgsHtml += `<img src="${imgFinal}" class="product-img ${activeClass}" data-idx="${i}" loading="lazy">`;
                });

                if(hayVarias) {
                    navHtml = `
                        <button class="carousel-btn prev" onclick="cambiarImg('${grupo.idGrupo}', -1, event)">&#10094;</button>
                        <button class="carousel-btn next" onclick="cambiarImg('${grupo.idGrupo}', 1, event)">&#10095;</button>
                    `;
                }

                // Variable actual (para mostrar texto si hay variantes)
                let textoVariableInicial = hayVarias ? grupo.variantes[0].VARIABLE : '';
                let htmlTag = textoVariableInicial && textoVariableInicial !== '√önica' 
                    ? `<div class="variant-tag" id="tag-${grupo.idGrupo}">${textoVariableInicial}</div>` 
                    : '';

                let nombreSeguro = String(grupo.nombre).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                let preciosUnicos = new Set(grupo.variantes.map(v => v.PRECIO));
                let uiPrecio = preciosUnicos.size > 1 
                    ? `<span class="price-desde">Desde</span>${formatoMoneda(grupo.precioMinimo)}` 
                    : formatoMoneda(grupo.precioMinimo);

                const card = document.createElement('div');
                card.className = 'product-card';
                // wrapper tiene data-current="0" para rastrear la imagen visible
                card.innerHTML = `
                    <div class="image-wrapper" id="wrapper-${grupo.idGrupo}" data-current="0">
                        ${imgsHtml}
                        ${navHtml}
                    </div>
                    <div class="info">
                        <div class="price" id="price-${grupo.idGrupo}">${uiPrecio}</div>
                        <div class="name">${grupo.nombre}</div>
                        ${htmlTag}
                        <button class="btn-add" onclick="agregarDesdeImagenActiva('${grupo.idGrupo}')">Agregar</button>
                    </div>
                `;
                container.appendChild(card);
            });

            itemsRenderizados += lote.length;
        }

        // --- L√ìGICA DE CARRUSEL ---
        window.cambiarImg = function(idGrupo, dir, event) {
            if(event) event.stopPropagation();
            
            let wrapper = document.getElementById('wrapper-' + idGrupo);
            let imgs = wrapper.querySelectorAll('.product-img');
            let current = parseInt(wrapper.getAttribute('data-current')) || 0;
            
            let nextIdx = (current + dir + imgs.length) % imgs.length;
            
            // Cambio visual
            imgs[current].classList.remove('active');
            imgs[nextIdx].classList.add('active');
            
            // Actualizar estado
            wrapper.setAttribute('data-current', nextIdx);
            
            // Actualizar Texto de Variante y Precio visualmente
            let grupo = window.diccionarioVariantes[idGrupo];
            let varianteActual = grupo.variantes[nextIdx];
            
            let tag = document.getElementById(`tag-${idGrupo}`);
            if(tag && varianteActual.VARIABLE !== '√önica') {
                tag.innerText = varianteActual.VARIABLE;
            }
            
            // Si los precios var√≠an, mostrar el precio exacto de la foto
            let priceDiv = document.getElementById(`price-${idGrupo}`);
            if(priceDiv) {
                priceDiv.innerText = formatoMoneda(varianteActual.PRECIO);
            }
        };

        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) {
                if (itemsRenderizados < productosFiltrados.length) { renderizarSiguienteLote(); }
            }
        });

        function aplicarFiltros() {
            let texto = document.getElementById('searchInput').value.toLowerCase();
            let tipoSel = document.getElementById('filterTipo').value;
            let sortDir = document.getElementById('sortPrecio').value;

            productosFiltrados = productosAgrupados.filter(g => {
                let coincideTexto = g.nombre.toLowerCase().includes(texto) || g.variantes.some(v => v.SKU && String(v.SKU).toLowerCase().includes(texto));
                let coincideTipo = tipoSel === "" || g.tipo === tipoSel;
                return coincideTexto && coincideTipo;
            });
            
            if (sortDir === 'recent') {
                productosFiltrados.sort((a, b) => b.originalIndex - a.originalIndex);
            } else if (sortDir === 'asc') {
                productosFiltrados.sort((a, b) => a.precioMinimo - b.precioMinimo);
            } else if (sortDir === 'desc') {
                productosFiltrados.sort((a, b) => b.precioMinimo - a.precioMinimo);
            }

            itemsRenderizados = 0;
            renderizarSiguienteLote();
        }

        // --- AGREGAR AL CARRITO SEG√öN LA FOTO VISIBLE ---
        function agregarDesdeImagenActiva(idGrupo) {
            let grupo = window.diccionarioVariantes[idGrupo];
            let wrapper = document.getElementById('wrapper-' + idGrupo);
            
            // Obtenemos el √≠ndice de la foto que el usuario est√° viendo
            let indexActivo = parseInt(wrapper.getAttribute('data-current')) || 0;
            
            let varianteElegida = grupo.variantes[indexActivo];
            
            let idUnico = varianteElegida.SKU || `${idGrupo}-${indexActivo}`;
            let nombreFull = varianteElegida.VARIABLE !== '√önica' ? `${grupo.nombre} - ${varianteElegida.VARIABLE}` : grupo.nombre;
            
            // Usamos la imagen espec√≠fica de esa variante
            let imagenBase = varianteElegida.IMAGEN || grupo.variantes[0].IMAGEN;
            let imagenFinal = procesarImagen(imagenBase);

            if (carrito[idUnico]) { 
                carrito[idUnico].cantidad += 1; 
            } else { 
                carrito[idUnico] = { 
                    id: idUnico, 
                    nombre: nombreFull, 
                    variableInfo: varianteElegida.VARIABLE, 
                    precio: varianteElegida.PRECIO, 
                    imagen: imagenFinal, 
                    cantidad: 1 
                }; 
            }
            
            actualizarUI_Carrito();
            mostrarToast();
        }

        function cambiarCantidad(id, delta) {
            if (carrito[id]) {
                carrito[id].cantidad += delta;
                if (carrito[id].cantidad <= 0) delete carrito[id];
                actualizarUI_Carrito();
            }
        }

        function actualizarUI_Carrito() {
            const container = document.getElementById('cart-items-container');
            const totalElem = document.getElementById('cart-total-price');
            const badge = document.getElementById('cart-count');
            
            container.innerHTML = ''; let total = 0; let cantidadItems = 0;

            Object.values(carrito).forEach(item => {
                let subtotal = item.precio * item.cantidad;
                total += subtotal; cantidadItems += item.cantidad;
                
                let divVariable = item.variableInfo !== '√önica' ? `<span class="cart-item-variant">${item.variableInfo}</span>` : '';

                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.imagen}" alt="img">
                        <div class="cart-item-info">
                            <div class="cart-item-title">${item.nombre}</div>
                            ${divVariable}
                            <div class="cart-item-price">${formatoMoneda(item.precio)}</div>
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="cambiarCantidad('${item.id}', -1)">-</button>
                                <span>${item.cantidad}</span>
                                <button class="qty-btn" onclick="cambiarCantidad('${item.id}', 1)">+</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            totalElem.textContent = formatoMoneda(total);
            badge.textContent = cantidadItems;
            if (cantidadItems === 0) { container.innerHTML = '<p style="text-align:center; margin-top:30px; color:#888;">Tu carrito est√° vac√≠o</p>'; }
        }

        function enviarPedido() {
            if (Object.keys(carrito).length === 0) return alert("Agrega al menos un producto para hacer el pedido.");
            let mensaje = "¬°Hola Forwarder Venture! üëã Quiero realizar este pedido:\n\n";
            let total = 0;

            Object.values(carrito).forEach(item => {
                let subtotal = item.precio * item.cantidad;
                total += subtotal;
                mensaje += `‚ñ™Ô∏è *${item.cantidad}x* ${item.nombre} (SKU: ${item.id})\n`;
            });

            mensaje += `\nüßæ *TOTAL A PAGAR: ${formatoMoneda(total)}*`;
            window.open(`https://wa.me/${NUMERO_WHATSAPP}?text=${encodeURIComponent(mensaje)}`, '_blank');
        }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function mostrarToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        cargarCatalogo();
    </script>
</body>
</html>
